name: Simple Build and Release

# æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read
  id-token: write

on:
  push:
    branches:
      - master  # æ¨é€æ—¶æ„å»ºå¹¶åˆ›å»ºRelease
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # 2. è®¾ç½® .NET ç¯å¢ƒ
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    # 3. è¿˜åŸä¾èµ–
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore l4d2External/l4d2External.csproj
      
    # 4. æ¸…ç†ä¹‹å‰çš„æ„å»º
    - name: ğŸ§¹ Clean previous builds
      run: dotnet clean l4d2External/l4d2External.csproj --configuration Release --verbosity quiet
      
    # 5. æ„å»ºå‘å¸ƒç‰ˆæœ¬
    - name: ğŸ—ï¸ Build and publish
      run: |
        dotnet publish l4d2External/l4d2External.csproj `
          --configuration Release `
          --runtime win-x86 `
          --self-contained true `
          --output "./publish" `
          --verbosity minimal
          
    # 6. éªŒè¯æ„å»ºç»“æœ
    - name: âœ… Check build result
      run: |
        if (Test-Path "./publish/l4d2External.exe") {
          $file = Get-Item "./publish/l4d2External.exe"
          $sizeMB = [math]::Round($file.Length / 1MB, 2)
          Write-Host "âœ… Build successful!" -ForegroundColor Green
          Write-Host "ğŸ“¦ File: l4d2External.exe" -ForegroundColor Cyan
          Write-Host "ğŸ“ Size: $($file.Length) bytes ($sizeMB MB)" -ForegroundColor Cyan
        } else {
          Write-Host "âŒ Build failed! Executable not found." -ForegroundColor Red
          exit 1
        }
        
    # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: l4d2External-${{ github.run_number }}
        path: ./publish/l4d2External.exe
        retention-days: 30
        
    # 8. åˆ›å»ºRelease
    - name: ğŸ‰ Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v1.0.${{ github.run_number }}"
        name: "ğŸ® æ±‚ç”Ÿä¹‹è·¯2è¾…åŠ© v1.0.${{ github.run_number }}"
        body: |
          ## ğŸ® æ±‚ç”Ÿä¹‹è·¯2å¤–éƒ¨è¾…åŠ©
          
          **ç‰ˆæœ¬:** v1.0.${{ github.run_number }}
          **æ„å»º:** #${{ github.run_number }}  
          **æäº¤:** ${{ github.sha }}
          
          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¯ **è‡ªç„ç³»ç»Ÿ** - æ™ºèƒ½è‡ªåŠ¨ç„å‡†åŠŸèƒ½
          - ğŸ‘ï¸ **é€è§†åŠŸèƒ½** - ç©¿å¢™æ˜¾ç¤ºæ•Œäººä½ç½®  
          - ğŸ° **è¿è·³åŠŸèƒ½** - è‡ªåŠ¨è¿ç»­è·³è·ƒ
          - ğŸ“¦ **å•æ–‡ä»¶** - æ— éœ€é¢å¤–ä¾èµ–
          - âš¡ **ä¼˜åŒ–æ€§èƒ½** - ä½“ç§¯å°ï¼Œæ€§èƒ½å¼º
          
          ### ğŸ“¥ ä¸‹è½½ä½¿ç”¨
          1. ä¸‹è½½ä¸‹æ–¹çš„ `l4d2External.exe` æ–‡ä»¶
          2. è¿è¡Œæ±‚ç”Ÿä¹‹è·¯2æ¸¸æˆ
          3. **ä»¥ç®¡ç†å‘˜èº«ä»½**è¿è¡Œè¯¥ç¨‹åº
          4. å¼€å§‹æ¸¸æˆï¼
          
          ### âš ï¸ é‡è¦æé†’
          - éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œ
          - ä½¿ç”¨é£é™©è‡ªè´Ÿ
          - ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨
          
          ---
          ğŸ¤– *é€šè¿‡GitHub Actionsè‡ªåŠ¨æ„å»º*
        files: ./publish/l4d2External.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # 9. å®Œæˆé€šçŸ¥
    - name: ğŸŠ Build Complete
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ Build completed successfully!" -ForegroundColor Green
        Write-Host "ğŸ“¦ Release v1.0.${{ github.run_number }} has been created!" -ForegroundColor Green
        Write-Host "ï¿½ Check: ${{ github.server_url }}/${{ github.repository }}/releases" -ForegroundColor Cyan
        Write-Host "ğŸ“ Backup copy also available in Actions Artifacts" -ForegroundColor Cyan
        Write-Host ""
